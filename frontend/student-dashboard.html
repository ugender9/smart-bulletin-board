<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Smart Bulletin Board</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .navbar { background: #2c3e50; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .navbar-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 20px; font-weight: bold; }
        .user-info { color: #ecf0f1; font-size: 14px; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .logout-btn:hover { background: #c0392b; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { color: #2c3e50; margin-bottom: 10px; }
        .sidebar { float: left; width: 20%; padding-right: 20px; }
        .main-content { float: left; width: 80%; }
        .filter-section { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50; }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
        .notices-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .notice-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; border-left: 5px solid #3498db; }
        .notice-card:hover { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .notice-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .notice-content { color: #555; margin-bottom: 15px; line-height: 1.6; font-size: 14px; }
        .notice-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-category { background: #3498db; color: white; }
        .badge-dept { background: #2ecc71; color: white; }
        .badge-high { background: #e74c3c; color: white; }
        .badge-medium { background: #f39c12; color: white; }
        .badge-low { background: #95a5a6; color: white; }
        .notice-date { font-size: 12px; color: #7f8c8d; }
        .loading { text-align: center; color: #7f8c8d; padding: 40px; }
        .no-notices { text-align: center; color: #7f8c8d; padding: 40px; background: white; border-radius: 8px; }
        .clearfix::after { content: ""; display: table; clear: both; }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-left">
            <div class="logo">üìö Smart Bulletin Board</div>
            <div class="user-info"><span id="userDisplay">Loading...</span></div>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

    <div class="container">
        <div class="header">
            <h1>Welcome, Student!</h1>
            <p>Your personalized campus notices</p>
        </div>

        <div class="clearfix">
            <div class="sidebar">
                <div class="filter-section">
                    <h3>üîç Filters</h3>
                    <div class="filter-group">
                        <label>Search Notices</label>
                        <input type="text" id="searchInput" placeholder="Search..." onkeyup="filterNotices()">
                    </div>
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="categoryFilter" onchange="filterNotices()">
                            <option value="">All Categories</option>
                            <option value="Academic">Academic</option>
                            <option value="Event">Event</option>
                            <option value="Deadline">Deadline</option>
                            <option value="Opportunity">Opportunity</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Department</label>
                        <select id="deptFilter" onchange="filterNotices()">
                            <option value="">All Departments</option>
                            <option value="CSE">CSE</option>
                            <option value="ECE">ECE</option>
                            <option value="MECH">MECH</option>
                            <option value="CIVIL">CIVIL</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div id="noticesList" class="notices-grid">
                    <div class="loading">Loading notices...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v11 (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
        import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAnz7rG5VmOo-4xCixTTFETGjHStEzptqA",
            authDomain: "techsprint-smartboard-d0a55.firebaseapp.com",
            databaseURL: "https://techsprint-smartboard-d0a55-default-rtdb.firebaseio.com",
            projectId: "techsprint-smartboard-d0a55",
            storageBucket: "techsprint-smartboard-d0a55.firebasestorage.app",
            messagingSenderId: "437326267964",
            appId: "1:437326267964:web:c70536d8ec8d3abecae539",
            measurementId: "G-MEPRGVM17Q"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.auth = auth;
        window.db = db;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.orderBy = orderBy;

        console.log("‚úÖ Firebase initialized for student dashboard!");
    </script>

    <script>
        let allNotices = [];
        let currentUser = null;
        let userDept = null;

        // Check if user is logged in
        window.onAuthStateChanged(window.auth, async (user) => {
            if (!user) {
                window.location.href = '/index.html';
                return;
            }
            currentUser = user;
            userDept = localStorage.getItem('userDept') || 'CSE';
            document.getElementById('userDisplay').textContent = `${user.email} (${userDept})`;
            deptFilter.value = userDept;
            loadNotices();
        });

        // Load notices from Firestore
        async function loadNotices() {
            try {
                const noticesRef = window.collection(window.db, 'notices');
                const q = window.query(noticesRef, window.orderBy('timestamp', 'desc'));
                const querySnapshot = await window.getDocs(q);
                
                allNotices = [];
                querySnapshot.forEach((doc) => {
                    allNotices.push({ id: doc.id, ...doc.data() });
                });
                
                displayNotices(allNotices);
            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('noticesList').innerHTML = '<div class="no-notices">Error loading notices: ' + error.message + '</div>';
            }
        }

        // Display notices with filters applied
        function displayNotices(notices) {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            const selectedDept = document.getElementById('deptFilter').value;

            let filtered = notices.filter(notice => {
                const matchesSearch = !searchQuery || notice.title.toLowerCase().includes(searchQuery) || notice.content.toLowerCase().includes(searchQuery);
                const matchesCategory = !selectedCategory || notice.category === selectedCategory;
                const matchesDept = !selectedDept || notice.department === selectedDept;
                return matchesSearch && matchesCategory && matchesDept;
            });

            if (filtered.length === 0) {
                document.getElementById('noticesList').innerHTML = '<div class="no-notices">No notices found matching your filters</div>';
                return;
            }

            const html = filtered.map(notice => `
                <div class="notice-card">
                    <div class="notice-title">${notice.title}</div>
                    <div class="notice-content">${notice.content}</div>
                    <div class="notice-meta">
                        <span class="badge badge-category">${notice.category}</span>
                        <span class="badge badge-dept">${notice.department}</span>
                        <span class="badge badge-${notice.importance.toLowerCase()}">${notice.importance}</span>
                    </div>
                    <div class="notice-date">Posted by: ${notice.postedBy} | ${new Date(notice.timestamp?.toDate?.() || notice.timestamp).toLocaleString()}</div>
                </div>
            `).join('');

            document.getElementById('noticesList').innerHTML = html;
        }

        // Filter notices
        function filterNotices() {
            displayNotices(allNotices);
        }

        // Handle logout
        async function handleLogout() {
            try {
                await window.signOut(window.auth);
                localStorage.clear();
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out: ' + error.message);
            }
        }
    </script>
</body>
</html>
